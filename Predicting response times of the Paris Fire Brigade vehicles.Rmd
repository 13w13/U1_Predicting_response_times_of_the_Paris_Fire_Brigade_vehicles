---
title: "Predicting response times of the Paris Fire Brigade vehicles"
author: "Edgar Jullien, Antoine Settelen, Simon Weiss"
date: '`r Sys.Date()`'

output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
---




Liens notebook inspiration artistique : 
Les notebooks qui ont déja fait le challenge : 
https://github.com/quachn/X_PFB
https://github.com/Gguinet/Fire-Brigade-Challenge/blob/master/.ipynb_checkpoints/Code-checkpoint.ipynb




Les notebooks traintant du même type de problème : 
https://medium.com/crim/predicting-the-response-times-of-firefighters-using-data-science-da79f6965f93
https://www.kaggle.com/gaborfodor/from-eda-to-the-top-lb-0-367
https://www.kaggle.com/karelrv/nyct-from-a-to-z-with-xgboost-tutorial
https://www.kaggle.com/headsortails/nyc-taxi-eda-update-the-fast-the-curious


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

## Presentation of the project

This group project responds to the **professor’s Nadine Galy instructions** written below :  
The project involves identifying a real-world business problem or opportunity and designing and implementing an analysis plan to address it using at least one of the modelling methods studied in the course. You are free to choose any business problem or opportunity or public policy issue that you consider challenging and useful to address using business analytics.
The data that you use should be readily available and verifiable.

This is a notebook for the [Paris Fire Brigate](https://paris-fire-brigade.github.io/data-challenge/challenge.html) data challenge with [ENS](https://challengedata.ens.fr/participants/challenges/21/) and [College de France](https://www.college-de-france.fr/site/stephane-mallat/Challenges-2020.htm).


**The goal of this playground challenge** is to predict the *The response times of the Paris Fire Brigade vehicles * which is the delay between:
* the selection of a rescue vehicle (the time when a rescue team is warned) 
* and the rescue team arrival time at the scene of the request (information sent manually via portable radio)

This measurement is composed by the 2 following periods of time: 
* the activation period of the rescue team 
* the transit time of the rescue team

Based on features like trip coordinates, pickup date, type of the arriavl destination, vehicules etc.. 

The [data](https://challengedata.ens.fr/participants/challenges/21/) which covers the entier year 2018 for which inoperable data have been squeezed out comes in the shape of 219 337 training observations and 108 033 test observation. The dataset covers the entire year 
Each row contains one Paris fire brigade intervention.

**In this notebook**, we will first study and visualise the original data, engineer new features, and examine potential outliers. Then... 

We hope that this notebook will have good results n the challenge and responds fully to Nadine Galy requirement.
As always, any feedback, questions, or constructive criticism are much appreciated.




## Features description




**Input parameters (x_train.csv and x_test.csv):**

* **[ID]** `emergency vehicle selection`: identifier of the selection instance of an emergency vehicle for an intervention
* Intervention
    * `intervention`: identifier of the intervention
    * Alert reason
        * `alert reason category` (category): alert reason category
        * `alert reason` (category): alert reason
    * Address
        * `intervention on public roads` (boolean): 1 when it concerns an intervention on public roads, 0 otherwise
        * `floor` (int): floor of the intervention
        * `location of the event` (category): qualifies the location of the emergency request, for example: entrance hall, boiler room, motorway, etc.
        * `longitude intervention` (float): approximate longitude of the intervention address. **ATTENTION: `intervention_longitude`** !
        * `latitude intervention` (float): approximate latitude of the intervention address. **ATTENTION: `intervention_latitude`** !
    * Emergency vehicle
        * `emergency vehicle`: identifier of the emergency vehicle
            * `emergency vehicle type` (category): type of the emergency vehicle
            * `rescue center` (category): identifier of the rescue center to which belong the vehicle (parking spot of the emergency vehicle)
        * `selection time` (datetime): selection time of the emergency vehicle
            * `date key selection` (int): selection date in YYYYMMDD format
            * `time key selection` (int): selection time in HHMMSS format
        * State of the emergency vehicle preceding its selection for an intervention
            * Operational status of the vehicle preceding its selection
                * `status preceding selection` (category): status of the emergency vehicle prior to selection. An emergency vehicle is in various statuses during an intervention:
                    * **Selection** - selection of the emergency vehicle by the rescue commitment application
                    * **Departed** - the vehicle starts its route to the location of the emergency request
                    * **Presented** - the vehicle arrives at the location of the request
                    * **Hospital transportation** - the vehicle starts its transport of a victim to hospital
                    * **Hospital arrival** - the vehicle arrives at the hospital
                    * **Leaving hospital** - the vehicle leaves the hospital
                    * **Returned** - the vehicle has returned to its parking spot
                    * **Leave the premises** - because the vehicle can also simply leave the scene of an intervention without having to transport any victim
                    * **Not available** - for various reasons the vehicle can be in an unavailable position
                    * **Not relevant** - statutes without interest
                * `delta status preceding selection-selection` (int): number of seconds before the vehicle was selected when its previous status was entered
            * `departed from its rescue center` (boolean) : 1 when the vehicle departed from its rescue center (emergency vehicle parking spot), 0 otherwise
            * GPS position of the vehicle before departure
                * `longitude before departure` (float): longitude of the position of the vehicle preceding his departure. **ATTENTION: `departure_longitude`** !
                * `latitude previous departure` (float): latitude of the position of the vehicle preceding his departure. **ATTENTION: `departure_latitude`** !
                * `delta position gps previous departure-departure` (int): number of seconds before the selection of the vehicle where its GPS position was recorded (when not parked at its emergency center)
            * GPS tracks
                * `GPS tracks departure-presentation` (float pair list): successive GPS positions (*longitude,latitude;longitude,latitude,* etc.) of the vehicle between departure and presentation. This information is for informational purposes to study vehicle behaviors. (The beacons, emitting the GPS positions of vehicles, are currently not always lit)
                * `GPS tracks departure-presentation datetime` (datetime list): datetime associated with successive GPS positions between the departure and the presentation of the vehicle.
            * Estimated route
                * `OSRM estimated route` (json object): service route response of an OSRM instance (http://project-osrm.org/docs/v5.15.2/api/#route-service) setup with the Ile-de-France OpenStreetMap data
                * `OSRM estimated distance` (float): distance calculated by the OSRM route service
                * `OSRM estimated duration` (float): transit delay calculated by the OSRM route service

**Output parameters (y_train.csv and y_test.csv):**

* **[ID]** `emergency vehicle selection`: identifier of the selection instance of an emergency vehicle for an intervention
* **[TO PREDICT]** `delta selection-departure`(int): elapsed time in seconds between the selection and the departure of the emergency vehicle
* **[TO PREDICT]** `delta departure-presentation`(int): elapsed time in seconds between the departure of the emergency vehicle and its presentation on the intervention scene
* **[TO PREDICT]** `delta selection-presentation `(int): elapsed time in seconds between the selection of the emergency vehicle and its presentation on the intervention scene (delta selection-departure + delta departure-presentation)



**Supplementary files (x_train_additional_file.csv and x_test_additional_file.csv)**

* **[ID]** `emergency vehicle selection`: identifier of the selection instance of an emergency vehicle for an intervention
* `OSRM estimate from last observed GPS position`(json object): service route response from last observed GPS position of an OSRM instance (http://project-osrm.org/docs/v5.15.2/api/#route-service) setup with the Ile-de-France OpenStreetMap data
* `OSRM estimated distance from last observed GPS position`(float): distance (in meters) calculated by the OSRM route service from last observed GPS position
* `OSRM estimated distance from last observed GPS position`(float): distance (in meters) calculated by the OSRM route service from last observed GPS position
* `OSRM estimated duration from last observed GPS position`(float): transit delay (in seconds) calculated by the OSRM route service from last observed GPS position
* `time elapsed between selection and last observed GPS position` (float): in seconds
* `updated OSRM estimated duration` (float): time elapsed (in seconds) between selection and last observed GPS position + OSRM estimated duration from last observed GPS position


Good reading ! 



```{r}
library(magrittr)
library(DataExplorer)
library(data.table)
```

## Load data, transform tem into Datatable for better computation time and combine them. 
```{r}
x_train <- read.csv("x_train.csv") %>% setDT
y_train <- read.csv("y_train.csv") %>% setDT
x_test <- read.csv("x_test.csv") %>% setDT
View(x_train)
data <- cbind(x_train,y_train)
```



## File structure and content

Let's have an overview of the data sets using the *summary* and *glimpse* tools. First the training data:

```{r}
summary(data)
```


And then the testing data:

```{r}
summary(x_test)
```



```{r}
#Explanatory Data
str(data)
data$location.of.the.event <- as.factor(data$location.of.the.event)
data$intervention.on.public.roads <- as.factor(data$intervention.on.public.roads )
data$emergency.vehicle.type <- as.factor(data$emergency.vehicle.type)
data$rescue.center <- as.factor(data$rescue.center)
data$status.preceding.selection  <- as.factor(data$status.preceding.selection)
data$departed.from.its.rescue.center  <- as.factor(data$departed.from.its.rescue.center)
data$OSRM.response <- NULL #temporaire

data$month <- months(as.Date(data$date.key.sélection))
data$month <- as.factor(data$month)



```
Check if NA

```{r}
sum(is.na(data))
```


```{r}
# quantitatives variables

# Histograms

hist(data$floor, col="blue",main="Floor")
hist(data$longitude.intervention, col="blue",main="Longitude intervention")
hist(data$latitude.intervention, col="blue",main="Latitutde intervention")
hist(data$delta.status.preceding.selection.selection , col="blue",main="delta status preceding selection-selection")
hist(data$delta.position.gps.previous.departure.departure, col="blue",main="delta position gps previous departure-departure (int)")
hist(data$longitude.before.departure, col="blue",main="longitude before departure ")
hist(data$latitude.before.departure, col="blue",main="Latitude before departure ")
hist(data$OSRM.estimated.distance, col="blue",main="OSRM estimated distance")
hist(data$OSRM.estimated.duration, col="blue",main="OSRM estimated duration")



# Boxplot
boxplot(data$floor, col="blue",main="Floor") #Outliers > 40
boxplot(data$longitude.intervention, col="blue",main="Longitude intervention")
boxplot(data$latitude.intervention, col="blue",main="Latitutde intervention")
boxplot(data$delta.status.preceding.selection.selection , col="blue",main="delta status preceding selection-selection") #Pas beau
boxplot(data$delta.position.gps.previous.departure.departure, col="blue",main="delta position gps previous departure-departure (int)")
boxplot(data$longitude.before.departure, col="blue",main="longitude before departure ")
boxplot(data$latitude.before.departure, col="blue",main="latitude before departure ")
boxplot(data$OSRM.estimated.distance, col="blue",main="OSRM estimated distance")
boxplot(data$OSRM.estimated.duration, col="blue",main="OSRM estimated duration")

# Manage outliers
# delete observations where floors > 60
data.clean <- data[data$floor < 40,]
boxplot(data.clean$floor, col="blue",main="Floor")

# transform variables
#no possible with floor as we have negative variable

data.clean$log.longitude.intervention <- log(data.clean$longitude.intervention)
data.clean$log.latitude.intervention<- log(data.clean$latitude.intervention)
data.clean$log.delta.status.preceding.selection.selection <- log(data.clean$delta.status.preceding.selection.selection)
data.clean$log.delta.position.gps.previous.departure.departure <- log(data.clean$delta.position.gps.previous.departure.departure) 
data.clean$log.longitude.before.departure <- log(data.clean$longitude.before.departure)
data.clean$log.latitude.before.departure <- log(data.clean$latitude.before.departure)
data.clean$log.OSRM.estimated.distance <- log(data.clean$OSRM.estimated.distance)
data.clean$log.OSRM.estimated.duration   <- log(data.clean$OSRM.estimated.duration)


# Histograms
hist(data.clean$log.longitude.intervention, col="blue",main="Log longitude intervention")
hist(data.clean$log.latitude.intervention, col="blue",main=" Log Latitutde intervention")
hist(data.clean$log.delta.status.preceding.selection.selection , col="blue",main=" Log delta status preceding selection-selection")
hist(data.clean$log.delta.position.gps.previous.departure.departure, col="blue",main="Log delta position gps previous departure-departure (int)")
hist(data.clean$log.longitude.before.departure, col="blue",main="Log longitude before departure ")
hist(data.clean$log.latitude.before.departure, col="blue",main="Log Latitude before departure ")
hist(data.clean$log.OSRM.estimated.distance, col="blue",main="Log OSRM estimated distance")
hist(data.clean$log.OSRM.estimated.duration, col="blue",main="Log OSRM estimated duration")


# Boxplot
boxplot(data.clean$log.longitude.intervention, col="blue",main="Log longitude intervention")
boxplot(data.clean$log.latitude.intervention, col="blue",main=" Log Latitutde intervention")
boxplot(data.clean$log.delta.status.preceding.selection.selection , col="blue",main=" Log delta status preceding selection-selection")
boxplot(data.clean$log.delta.position.gps.previous.departure.departure, col="blue",main="Log delta position gps previous departure-departure (int)")
boxplot(data.clean$log.longitude.before.departure, col="blue",main="Log longitude before departure ")
boxplot(data.clean$log.latitude.before.departure, col="blue",main="Log Latitude before departure ")
boxplot(data.clean$log.OSRM.estimated.distance, col="blue",main="Log OSRM estimated distance")
boxplot(data.clean$log.OSRM.estimated.duration, col="blue",main="Log OSRM estimated duration")
summary(data.clean)

# Normality study
# QQ Plot
# when the variable is normally distributed
# points are aligned on the first bisector

qqnorm(data.clean$floor, main="Normality floor")
qqline(data.clean$floor)

qqnorm(data.clean$longitude.intervention, main="Normality longitude intervention")
qqline(data.clean$longitude.intervention)
qqnorm(data.clean$log.longitude.intervention, main="Normality log longitude intervention")
qqline(data.clean$log.longitude.intervention)

qqnorm(data.clean$latitude.intervention, main="Normality latitude intervention")
qqline(data.clean$latitude.intervention)
qqnorm(data.clean$log.latitude.intervention, main="Normality log latitude intervention")
qqline(data.clean$log.latitude.intervention)

qqnorm(data.clean$delta.status.preceding.selection.selection, main="Normality delta status preceding selection-selection")
qqline(data.clean$delta.status.preceding.selection.selection)
#qqnorm(data.clean$log.delta.status.preceding.selection.selection, main="Normality log delta status preceding selection-selectio")
#not possible

qqnorm(data.clean$delta.position.gps.previous.departure.departure, main="Normality delta status preceding selection-selection")
qqline(data.clean$delta.position.gps.previous.departure.departure)
#qqnorm(data.clean$log.delta.position.gps.previous.departure.departure, main="Normality log delta status preceding selection-selection")
#not possible

qqnorm(data.clean$longitude.before.departure, main="Normality longitude before departure")
qqline(data.clean$longitude.before.departure)
qqnorm(data.clean$log.longitude.before.departure, main="Normality log longitude before departure")
qqline(data.clean$log.longitude.before.departure)

qqnorm(data.clean$latitude.before.departure, main="Normality latitude before departure")
qqline(data.clean$latitude.before.departure)
qqnorm(data.clean$log.latitude.before.departure, main="Normality log latitude before departure")
qqline(data.clean$log.latitude.before.departure)

qqnorm(data.clean$OSRM.estimated.distance, main="NormalityOSRM estimated distance")
qqline(data.clean$OSRM.estimated.distance)
qqnorm(data.clean$log.OSRM.estimated.distance, main="Normality log OSRM estimated distance")
qqline(data.clean$log.OSRM.estimated.distance)

qqnorm(data.clean$OSRM.estimated.duration, main="Normality OSRM estimated duration")
qqline(data.clean$OSRM.estimated.duration)
qqnorm(data.clean$log.OSRM.estimated.duration, main="Normality log OSRM estimated duration")
qqline(data.clean$log.OSRM.estimated.duration)


#Qualitatives variables


tapply(data.clean$delta.departure.presentation, data.clean$alert.reason.category, summary)
bartlett.test(data.clean$delta.departure.presentation, data.clean$alert.reason.category)
bartlett.test(data.clean$delta.departure.presentation, data.clean$intervention.on.public.roads) #pvalue <0,05
bartlett.test(data.clean$delta.departure.presentation, data.clean$status.preceding.selection) #pvalue <0,05
bartlett.test(data.clean$delta.departure.presentation, data.clean$departed.from.its.rescue.center)#pvalue <0,05
bartlett.test(data.clean$delta.departure.presentation, data.clean$month)#pvalue <0,05

data.clean$departed.from.its.rescue.center
```


Etude de correlation, PCA pour réduire facteur et variable. 

Regrouper véhicule, ressources center, location of the event

```{r}
#Linear Regression,

lm <- lm(data.clean$delta.selection.presentation ~ data.clean$floor+data.clean$longitude.intervention+data.clean$latitude.intervention+data.clean$delta.status.preceding.selection.selection+data.clean$delta.position.gps.previous.departure.departure+data.clean$longitude.before.departure+data.clean$latitude.before.departure+data.clean$OSRM.estimated.distance+data.clean$OSRM.estimated.duration+factor(data.clean$intervention.on.public.roads), data=data.clean)

summary(lm)


lm1 <- lm(data.clean$delta.selection.presentation ~ data.clean$floor+data.clean$latitude.intervention+data.clean$delta.status.preceding.selection.selection+data.clean$delta.position.gps.previous.departure.departure+data.clean$longitude.before.departure+data.clean$latitude.before.departure+data.clean$OSRM.estimated.distance+data.clean$OSRM.estimated.duration+factor(data.clean$intervention.on.public.roads), data=data.clean)
summary(lm1)

lm2 <- lm(data.clean$delta.selection.presentation ~ data.clean$floor+data.clean$latitude.intervention+data.clean$delta.status.preceding.selection.selection+data.clean$longitude.before.departure+data.clean$latitude.before.departure+data.clean$OSRM.estimated.distance+data.clean$OSRM.estimated.duration+factor(data.clean$intervention.on.public.roads), data=data.clean)
summary(lm2)

lm3 <- lm(data.clean$delta.selection.presentation ~ data.clean$floor+data.clean$latitude.intervention+data.clean$delta.status.preceding.selection.selection+data.clean$latitude.before.departure+data.clean$OSRM.estimated.distance+data.clean$OSRM.estimated.duration+factor(data.clean$intervention.on.public.roads), data=data.clean)
summary(lm3)

```
Just for test 
```{r}
lm.selection.departure <- lm(data.clean$delta.selection.departure~., data=data.clean[,-1])

summary(lm.selection.departure)

lm1.selection.departure<-(data.clean$delta.selection.departure ~data.clean$delta.status.preceding.selection.selection+factor(data.clean$intervention.on.public.roads), data=data.clean)
summary(lm1.selection.departure)

```


```{r}
library(tree)
tree1.train <-  tree(delta.selection.departure~.,data=data.clean[,-c(7,1,11,12)])
summary(tree1.train)
plot(tree1.train)
text(tree1.train,pretty = 0)

tree1.predict<-predict(tree1.train, newdata=x_test)

```

